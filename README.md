# Gemini - Android

这是一个利用大语言模型(LLM)通过`Android`无障碍服务来控制手机的项目
该项目允许`LLM`接收用户的指令, 并通过函数调用执行相应的操作来控制`Android`设备

## 项目概述

通过自然语言交互, 用户可以与`Gemini`大模型对话以及配置函数功能, 指示LLM执行各种操作, 典型实现是利用`Google`的`Gemini`模型的能力, 结合`Android`无障碍服务接口, 实现了智能化的手机操作控制, 而无需直接与设备交互

## 主要功能

- 基于`Gemini`的自然语言理解与处理
- 基于`Gemini-Live-Api`的`wss`双全工语音通话
- 通过函数调用框架执行设备操作
- 通过配置设置框架设置LLM请求偏好如: 流式传输、温度等选项
- 利用`Android`无障碍服务实现UI交互与界面元素分析
- 支持多轮对话的聊天界面
- 执行`Shell`命令(支持通过`Root`或`Shizuku`运行特权命令)
- 获取当前屏幕视图元素信息
- 支持常规的手机操作功能如: 点击、滑动
- 追踪前台应用变化
- 获取应用列表和前台应用信息
- 自动循环切换`api-key`以避免请求限速

## 技术实现

### LLM集成

项目使用`Google`的`Gemini`模型, 通过官方SDK进行集成: 
- 支持绝大部分`Gemini-Api`的偏好设置, 包括但不限于: 温度、TopP、TopK、频率惩罚等
- 使用MVI模式对多轮对话的请求和UI进行管理
- 实现`api-key`自动轮换机制, 每次请求自动切换`api-key`

### `api-key`管理系统

为了解决Api调用频率限制问题, 项目实现了`api-key`轮换系统: 
- 支持配置多个`api-key`存储在资源文件中
- 每次请求自动切换到下一个可用的`api-key`
- 使用`AtomicInteger`实现无锁切换, 适合低并发场景
- 记录`Api`切换频率, 提供`Api`调用速率统计
- 通过`DataStore`持久化当前`api-key`索引, 确保应用重启后连续性

### 耦合度控制

项目使用现代思想解耦
- 通过面向接口思想和MVI架构解耦
- 通过多模块降低单模块的大小
- 合理的分包
- 大量的拓展函数

### 函数调用框架

函数调用是本项目的核心, 允许LLM执行预定义的操作: 

- **函数管理器**: `FuncManager`统一管理所有可用功能函数
- **动态注册**: 通过`sealed class`反射能力动态注册所有`sealed`子类以注册所有函数
- **基础函数模型**: `BaseFuncModel`定义函数调用的标准接口和规范
- **功能实现**:
  - 屏幕视图数获取
  - 屏幕长短按点击
  - 屏幕滚动
  - 基于安卓`Intent`的`Uri`打开, 实现地图、电话拨打等功能
  - `Root`级别的`Shell`执行器(由于安全问题未暴露给`LLM`)
  - `Toast`消息提示
  - 基于无障碍的节点操作如: 点击、滑动、设置文本
  - 基于`Shell`的应用列表获取
  - 基于`Shell`的应用启动
  - 基于`Shell`的`Input Keyevent`功能, 实现发送返回键等
  - 前台应用信息获取

### 无障碍服务实现

项目利用`Android`的无障碍服务`Api`实现界面交互, 主要功能包括: 

- 获取屏幕视图树
- 通过自定义哈希值计算向大模型提供节点`Action`功能

## `Shell`执行系统

项目实现了一个灵活的`Shell`命令执行系统: 

- 支持三种执行方式: 普通用户权限、Root权限和`Shizuku`权限
- 返回标准化的`ShellResult`结果

## `Shizuku`集成

项目整合了`Shizuku`服务, 提供了在非`Root`环境下执行特权命令的能力: 

- 实现了`Shizuku`权限请求和管理逻辑
- 利用`Shizuku`执行高权限`Shell`命令
- 单独模块化封装`Shizuku`功能, 便于维护和更新

## 开发自定义功能

要添加新的函数调用功能, 需要遵循以下步骤: 

1. 创建新的函数模型类, 继承`BaseFuncModel`
2. 实现必要的抽象方法和属性: `name`、`description`、`parameters`和`call`
3. 使用`data object`定义实现类, 自动注册到`FuncManager`
4. 确保函数返回统一格式的`Map`类型